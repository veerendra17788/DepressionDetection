{% extends "base.html" %}

{% block title %}Text Analysis - MindWatch{% endblock %}

{% block content %}
<div class="container" style="padding-top: 2rem;">
    <div style="max-width: 900px; margin: 0 auto;">
        <h1 style="margin-bottom: 1.5rem;">Depression Analysis</h1>
        <p style="color: var(--gray); margin-bottom: 2rem;">
            Enter text from your journals, social media posts, or thoughts to analyze emotional patterns.
        </p>
        
        <div class="glass-card fade-in">
            <div class="form-group">
                <textarea id="analysis-input" class="form-control" rows="6" placeholder="How are you feeling today? What's on your mind?" style="resize: vertical; font-size: 1.1rem;"></textarea>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 0.9rem; color: var(--gray);">
                    <span class="material-icons" style="font-size: 1rem; vertical-align: middle;">lock</span>
                    Private & Secure
                </span>
                <button id="analyze-btn" class="btn btn-primary">
                    <span class="material-icons">analytics</span> Analyze Text
                </button>
            </div>
        </div>
        
        <!-- Results Section (Hidden initially) -->
        <div id="results-section" class="hidden" style="margin-top: 3rem;">
            <h2 style="margin-bottom: 1.5rem;">Analysis Results</h2>
            
            <!-- Result Prediction -->
            <div class="glass-card fade-in" style="margin-bottom: 2rem; border-left: 5px solid transparent;" id="result-card">
                <div style="display: flex; align-items: center; gap: 1.5rem;">
                    <div id="result-icon-container" style="width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons" style="font-size: 2rem; color: white;" id="result-icon"></span>
                    </div>
                    <div>
                        <h3 style="margin: 0;" id="result-label">--</h3>
                        <p style="margin: 0; color: var(--gray);">Confidence: <span id="result-confidence">--</span>%</p>
                    </div>
                </div>
                
                <div id="crisis-alert" class="hidden" style="margin-top: 1.5rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: var(--radius-md);">
                    <div style="display: flex; align-items: center; gap: 1rem; color: var(--danger);">
                        <span class="material-icons">warning</span>
                        <strong>Crisis Alert Detected</strong>
                    </div>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                        This text indicates high levels of distress. Please consider reaching out for support.
                        <a href="/resources" style="text-decoration: underline; font-weight: 600;">View Helplines</a>
                    </p>
                </div>
            </div>
            
            <!-- Explainable AI -->
            <div class="glass-card fade-in delay-100" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">Word Impact Analysis</h3>
                <p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 1.5rem;">
                    See which words most influenced the model's prediction.
                </p>
                <div id="attention-visualization" style="line-height: 2; font-size: 1.1rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
                    <!-- Impact words injected here -->
                </div>
            </div>
            
            <!-- Emotion Breakdown -->
            <div class="glass-card fade-in delay-200" style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0;">Emotion Breakdown</h3>
                    <div id="mood-score-badge" style="padding: 0.5rem 1rem; background: var(--primary); border-radius: var(--radius-lg); font-weight: 600;">
                        Mood: <span id="mood-score">--</span>/10
                    </div>
                </div>
                
                <div id="emotion-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <!-- Emotion bars will be injected here -->
                </div>
                
                <div id="dominant-emotions" style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
                    <strong>Dominant Emotions:</strong> <span id="dominant-list">--</span>
                </div>
            </div>
            
            <!-- Analysis Settings -->
            <div class="glass-card fade-in delay-300" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">Analysis Settings</h3>
                <div style="display: grid; gap: 1rem;">
                    <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                        <input type="checkbox" id="show-attention" checked style="width: 20px; height: 20px; cursor: pointer;">
                        <span>Show word impact visualization</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                        <input type="checkbox" id="show-emotions" checked style="width: 20px; height: 20px; cursor: pointer;">
                        <span>Show detailed emotion breakdown</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                        <input type="checkbox" id="auto-save" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>Automatically save to journal</span>
                    </label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span>Sensitivity:</span>
                        <input type="range" id="sensitivity" min="0" max="100" value="50" style="flex: 1;">
                        <span id="sensitivity-value">50%</span>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button onclick="saveToJournal()" class="btn btn-outline">
                    <span class="material-icons">book</span> Save to Journal
                </button>
                <a href="/resources" class="btn btn-outline">
                    <span class="material-icons">spa</span> Get Support
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let lastAnalysisResult = null;
    let lastText = '';
    
    document.addEventListener('DOMContentLoaded', () => {
        // Check for URL params (from dashboard quick action)
        const urlParams = new URLSearchParams(window.location.search);
        const text = urlParams.get('text');
        if (text) {
            document.getElementById('analysis-input').value = decodeURIComponent(text);
            analyzeText(decodeURIComponent(text));
        }
        
        document.getElementById('analyze-btn').addEventListener('click', () => {
            const input = document.getElementById('analysis-input').value.trim();
            if(!input) return App.ui.toast('Please enter text', 'error');
            analyzeText(input);
        });
    });
    
    async function analyzeText(text) {
        lastText = text;
        const btn = document.getElementById('analyze-btn');
        const resultsSection = document.getElementById('results-section');
        
        App.ui.showLoading(btn);
        resultsSection.classList.add('hidden');
        
        try {
            const data = await App.api.post('/analysis/analyze', { text });
            lastAnalysisResult = data.result;
            
            // Try to fetch emotion breakdown (optional)
            let emotionBreakdown = null;
            try {
                const emotionData = await App.api.post('/analysis/emotion-breakdown', { text });
                emotionBreakdown = emotionData.breakdown;
            } catch (emotionError) {
                console.warn('Emotion breakdown failed, continuing without it:', emotionError);
            }
            
            displayResults(data.result, emotionBreakdown);
            App.ui.hideLoading(btn);
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
            
            // Auto-save if enabled
            if (document.getElementById('auto-save').checked) {
                setTimeout(() => saveToJournal(), 500);
            }
            
        } catch (error) {
            App.ui.toast(error.message, 'error');
            App.ui.hideLoading(btn);
        }
    }
    
    function displayResults(result, emotionBreakdown) {
        const isDepressed = result.label === 'Depressed';
        const confidence = Math.round(result.confidence * 100);
        
        // Update Card Style
        const card = document.getElementById('result-card');
        card.style.borderLeftColor = isDepressed ? 'var(--warning)' : 'var(--success)';
        
        // Update Icon
        const iconContainer = document.getElementById('result-icon-container');
        const icon = document.getElementById('result-icon');
        
        if (isDepressed) {
            iconContainer.style.background = 'var(--warning)';
            icon.textContent = 'sentiment_dissatisfied';
        } else {
            iconContainer.style.background = 'var(--success)';
            icon.textContent = 'sentiment_satisfied_alt';
        }
        
        // Update Text
        document.getElementById('result-label').textContent = isDepressed ? 'Signs of Depression Detected' : 'No Signs of Depression';
        document.getElementById('result-confidence').textContent = confidence;
        
        // Crisis Alert
        const crisisAlert = document.getElementById('crisis-alert');
        if (result.is_crisis) {
            crisisAlert.classList.remove('hidden');
        } else {
            crisisAlert.classList.add('hidden');
        }
        
        // Word Impact Visualization
        if (document.getElementById('show-attention').checked) {
            displayAttention(result, isDepressed);
        }
        
        // Emotion Breakdown
        if (document.getElementById('show-emotions').checked && emotionBreakdown) {
            displayEmotionBreakdown(emotionBreakdown);
        }
    }
    
    function displayAttention(result, isDepressed) {
        const visContainer = document.getElementById('attention-visualization');
        visContainer.innerHTML = '';
        
        if (result.attention && result.attention.length > 0) {
            let html = '';
            result.attention.forEach(item => {
                const word = item.token.replace('##', '');
                const intensity = item.attention * 5;
                const color = isDepressed ? `rgba(245, 158, 11, ${Math.min(intensity, 0.8)})` : `rgba(16, 185, 129, ${Math.min(intensity, 0.8)})`;
                
                html += `<span style="display: inline-block; padding: 2px 6px; margin: 3px; background: ${color}; border-radius: 4px;">${word}</span> `;
            });
            visContainer.innerHTML = html + '<div style="margin-top:10px; font-size: 0.8rem; color: var(--gray);">Top words influencing the model</div>';
        } else {
            visContainer.textContent = lastText;
        }
    }
    
    function displayEmotionBreakdown(breakdown) {
        // Hide emotion section if no data
        const emotionSection = document.querySelector('#emotion-grid').closest('.glass-card');
        if (!breakdown) {
            if (emotionSection) emotionSection.style.display = 'none';
            return;
        }
        if (emotionSection) emotionSection.style.display = 'block';
        
        // Mood Score
        const moodScore = breakdown.mood_score || 5;
        document.getElementById('mood-score').textContent = moodScore;
        const moodBadge = document.getElementById('mood-score-badge');
        if (moodScore >= 7) {
            moodBadge.style.background = 'var(--success)';
        } else if (moodScore >= 4) {
            moodBadge.style.background = 'var(--primary)';
        } else {
            moodBadge.style.background = 'var(--warning)';
        }
        
        // Emotion Grid
        const emotionGrid = document.getElementById('emotion-grid');
        emotionGrid.innerHTML = '';
        
        const emotionColors = {
            'sadness': '#6366f1',
            'anxiety': '#8b5cf6',
            'anger': '#ef4444',
            'hopelessness': '#dc2626',
            'loneliness': '#7c3aed',
            'fear': '#f59e0b',
            'guilt': '#ec4899',
            'joy': '#10b981',
            'contentment': '#14b8a6',
            'excitement': '#06b6d4'
        };
        
        if (breakdown.emotions) {
            Object.entries(breakdown.emotions).forEach(([emotion, value]) => {
                const percentage = Math.round(value * 100);
                const color = emotionColors[emotion] || '#6366f1';
                
                const emotionCard = `
                    <div style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="text-transform: capitalize; font-weight: 500;">${emotion}</span>
                            <span style="color: ${color};">${percentage}%</span>
                        </div>
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: ${color}; width: ${percentage}%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
                emotionGrid.innerHTML += emotionCard;
            });
        }
        
        // Dominant Emotions
        if (breakdown.dominant_emotions && breakdown.dominant_emotions.length > 0) {
            const dominantText = breakdown.dominant_emotions
                .map(e => `${e.emotion} (${Math.round(e.intensity * 100)}%)`)
                .join(', ');
            document.getElementById('dominant-list').textContent = dominantText;
        }
    }
    
    // Settings event listeners
    document.addEventListener('DOMContentLoaded', () => {
        const sensitivitySlider = document.getElementById('sensitivity');
        const sensitivityValue = document.getElementById('sensitivity-value');
        
        sensitivitySlider.addEventListener('input', (e) => {
            sensitivityValue.textContent = e.target.value + '%';
        });
        
        // Toggle visibility
        document.getElementById('show-attention').addEventListener('change', (e) => {
            document.querySelector('#attention-visualization').closest('.glass-card').style.display = 
                e.target.checked ? 'block' : 'none';
        });
        
        document.getElementById('show-emotions').addEventListener('change', (e) => {
            document.querySelector('#emotion-grid').closest('.glass-card').style.display = 
                e.target.checked ? 'block' : 'none';
        });
    });
    
    async function saveToJournal() {
        if (!lastText) return;
        
        try {
            await App.api.post('/journal/', {
                content: lastText,
                title: 'Analysis Entry - ' + new Date().toLocaleDateString()
            });
            App.ui.toast('Saved to journal successfully', 'success');
            setTimeout(() => window.location.href = '/journal', 1000);
        } catch (error) {
            App.ui.toast(error.message, 'error');
        }
    }
</script>
{% endblock %}
