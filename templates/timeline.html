{% extends "base.html" %}

{% block title %}Emotional Timeline - MindWatch{% endblock %}

{% block content %}
<div class="container" style="padding-top: 2rem;">
    <div style="margin-bottom: 2rem;">
        <h1>Emotional Timeline</h1>
        <p style="color: var(--gray);"> Visualize your mood trends over time to better understand your emotional journey.</p>
    </div>
    
    <div class="glass-card fade-in" style="padding: 2rem; margin-bottom: 2rem;">
        <div style="height: 400px; width: 100%;">
            <canvas id="timelineChart"></canvas>
        </div>
    </div>
    
    <div class="glass-card fade-in delay-100" style="padding: 2rem;">
        <h3>Insights</h3>
        <p style="color: var(--gray);" id="insights-text">Loading insights based on your data...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', loadTimeline);
    
    async function loadTimeline() {
        try {
            const data = await App.api.get('/analysis/timeline?days=30');
            
            if (data.timeline.length === 0) {
                document.getElementById('insights-text').textContent = "Not enough data yet. Try analyzing some text or adding journal entries to see your timeline.";
                return;
            }
            
            const dates = data.timeline.map(item => new Date(item.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
            const scores = data.timeline.map(item => item.mood_score);
            const depressionProbs = data.timeline.map(item => item.depression_prob * 100);
            
            // Calculate trend insights
            const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
            let insight = "";
            if (avg > 7) insight = "Your overall mood seems positive lately. Keep up the good habits!";
            else if (avg > 4) insight = "Your mood has been fluctuating. Monitoring your triggers might help.";
            else insight = "Your mood has been low recently. Consider reaching out to a friend or using our self-help resources.";
            
            document.getElementById('insights-text').textContent = insight;
            
            const ctx = document.getElementById('timelineChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Mood Score (0-10)',
                            data: scores,
                            borderColor: '#10b981', // Success color
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Depression Probability (%)',
                            data: depressionProbs,
                            borderColor: '#f59e0b', // Warning color
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 0,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 10,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8' },
                            title: {
                                display: true,
                                text: 'Mood Score',
                                color: '#94a3b8'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#f59e0b' }, // Output scale color
                             title: {
                                display: true,
                                text: 'Depression Probability %',
                                color: '#f59e0b'
                            }
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error(error);
            document.getElementById('insights-text').textContent = "Error loading timeline data.";
        }
    }
</script>
{% endblock %}
