{% extends "base.html" %}

{% block title %}Journal - MindWatch{% endblock %}

{% block content %}
<div class="container" style="padding-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>My Journal</h1>
        <button onclick="openEntryModal()" class="btn btn-primary">
            <span class="material-icons">add</span> New Entry
        </button>
    </div>
    
    <!-- Journal Entries Grid -->
    <div id="journal-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
        <!-- Entries loaded here -->
        <div class="text-center" style="grid-column: 1/-1; padding: 3rem; color: var(--gray);">
            Loading entries...
        </div>
    </div>
</div>

<!-- Entry Modal -->
<div id="entry-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center;">
    <div class="glass-card" style="width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative;">
        <button onclick="closeEntryModal()" style="position: absolute; top: 1.5rem; right: 1.5rem; background: none; border: none; color: var(--gray); cursor: pointer;">
            <span class="material-icons">close</span>
        </button>
        
        <h2 style="margin-bottom: 1.5rem;" id="modal-title">New Entry</h2>
        
        <form id="journal-form">
            <div class="form-group">
                <input type="text" name="title" class="form-control" placeholder="Title (e.g., Morning Thoughts)" style="font-size: 1.2rem; font-weight: 600;">
            </div>
            
            <div class="form-group">
                <textarea name="content" class="form-control" rows="12" placeholder="Write your thoughts here..." required style="resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeEntryModal()" class="btn btn-outline">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Entry</button>
            </div>
        </form>
    </div>
</div>

<!-- View Modal -->
<div id="view-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center;">
    <div class="glass-card" style="width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative;" id="view-content">
        <!-- Content loaded dynamically -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', loadEntries);
    
    async function loadEntries() {
        try {
            const data = await App.api.get('/journal/');
            const grid = document.getElementById('journal-grid');
            grid.innerHTML = '';
            
            if (data.entries.length === 0) {
                grid.innerHTML = `
                    <div class="text-center" style="grid-column: 1/-1; padding: 4rem; color: var(--gray); border: 2px dashed rgba(255,255,255,0.1); border-radius: var(--radius-xl);">
                        <span class="material-icons" style="font-size: 3rem; opacity: 0.5; margin-bottom: 1rem;">book</span>
                        <h3>No entries yet</h3>
                        <p>Start writing to track your thoughts and feelings.</p>
                        <button onclick="openEntryModal()" class="btn btn-primary mt-2">Create First Entry</button>
                    </div>
                `;
                return;
            }
            
            data.entries.forEach(entry => {
                const date = new Date(entry.created_at).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const emotion = entry.emotion_summary;
                
                let emotionBadge = '';
                if (emotion) {
                    const color = emotion.label === 'Depressed' ? 'var(--warning)' : 'var(--success)';
                    emotionBadge = `<span style="font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; border: 1px solid ${color}; color: ${color}; margin-bottom: 0.5rem; display: inline-block;">${emotion.label}</span>`;
                }
                
                const card = document.createElement('div');
                card.className = 'glass-card fade-in';
                card.style.cssText = 'padding: 1.5rem; cursor: pointer; transition: transform 0.2s;';
                card.onclick = () => viewEntry(entry.id);
                
                card.innerHTML = `
                    ${emotionBadge}
                    <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">${entry.title || 'Untitled'}</h3>
                    <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 1rem;">${date}</p>
                    <p style="color: var(--light); font-size: 0.95rem; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                        ${entry.preview}
                    </p>
                `;
                
                grid.appendChild(card);
            });
            
        } catch (error) {
            console.error('Failed to load journals', error);
        }
    }
    
    function openEntryModal() {
        document.getElementById('entry-modal').style.display = 'flex';
    }
    
    function closeEntryModal() {
        document.getElementById('entry-modal').style.display = 'none';
        document.getElementById('journal-form').reset();
    }
    
    document.getElementById('journal-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        App.ui.showLoading(btn);
        
        try {
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            await App.api.post('/journal/', data);
            
            App.ui.toast('Entry saved', 'success');
            closeEntryModal();
            loadEntries(); // Refresh list
            
        } catch (error) {
            App.ui.toast(error.message, 'error');
        } finally {
            App.ui.hideLoading(btn);
        }
    });
    
    async function viewEntry(id) {
        try {
            const entry = await App.api.get(`/journal/${id}`);
            const modal = document.getElementById('view-modal');
            const content = document.getElementById('view-content');
            
            const date = new Date(entry.created_at).toLocaleString();
            
            content.innerHTML = `
                <button onclick="document.getElementById('view-modal').style.display='none'" style="position: absolute; top: 1.5rem; right: 1.5rem; background: none; border: none; color: var(--gray); cursor: pointer;">
                    <span class="material-icons">close</span>
                </button>
                
                <h2 style="margin-bottom: 0.5rem;">${entry.title || 'Untitled'}</h2>
                <div style="color: var(--gray); font-size: 0.9rem; margin-bottom: 2rem; display: flex; gap: 1rem; align-items: center;">
                    <span>${date}</span>
                    ${entry.emotion_summary ? `<span style="padding: 2px 8px; border-radius: 4px; background: rgba(255,255,255,0.1);">${entry.emotion_summary.label}</span>` : ''}
                </div>
                
                <div style="line-height: 1.8; white-space: pre-wrap;">${entry.content}</div>
                
                <div style="margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: flex-end;">
                    <button onclick="deleteEntry(${entry.id})" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <span class="material-icons" style="font-size: 1.1rem;">delete</span> Delete
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        } catch (error) {
            App.ui.toast(error.message, 'error');
        }
    }
    
    async function deleteEntry(id) {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        
        try {
            await App.api.delete(`/journal/${id}`);
            App.ui.toast('Entry deleted', 'success');
            document.getElementById('view-modal').style.display = 'none';
            loadEntries();
        } catch (error) {
            App.ui.toast(error.message, 'error');
        }
    }
</script>
{% endblock %}
